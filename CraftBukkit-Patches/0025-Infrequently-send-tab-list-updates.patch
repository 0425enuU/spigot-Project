From fea4d2a2bb5531b602f0026fd9a34524dea9c142 Mon Sep 17 00:00:00 2001
From: md_5 <md_5@live.com.au>
Date: Sat, 16 Feb 2013 19:05:15 +1100
Subject: [PATCH] Infrequently send tab list updates.

---
 src/main/java/net/minecraft/server/PlayerList.java | 13 ++++++++-----
 src/main/java/org/bukkit/craftbukkit/Spigot.java   |  2 ++
 src/main/resources/configurations/bukkit.yml       |  1 +
 3 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index d13fa19..3fc66aa 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -655,13 +655,16 @@ public abstract class PlayerList {
             this.o = 0;
         }
 
-        /* CraftBukkit start - remove updating of lag to players -- it spams way to much on big servers.
-        if (this.o < this.players.size()) {
+        if (org.bukkit.craftbukkit.Spigot.tabPing && this.o < this.players.size()) {
             EntityPlayer entityplayer = (EntityPlayer) this.players.get(this.o);
-
-            this.sendAll(new Packet201PlayerInfo(entityplayer.name, true, entityplayer.ping));
+            Packet packet = new Packet201PlayerInfo(entityplayer.listName, true, entityplayer.ping);
+            for (int i = 0; i < this.players.size(); ++i) {
+                PlayerConnection con = ((EntityPlayer) this.players.get(i)).playerConnection;
+                if (con.getPlayer().canSee(entityplayer.getBukkitEntity())) {
+                    con.sendPacket(packet);
+                }
+            }
         }
-        // CraftBukkit end */
     }
 
     public void sendAll(Packet packet) {
diff --git a/src/main/java/org/bukkit/craftbukkit/Spigot.java b/src/main/java/org/bukkit/craftbukkit/Spigot.java
index a5b05ed..8c67fc3 100644
--- a/src/main/java/org/bukkit/craftbukkit/Spigot.java
+++ b/src/main/java/org/bukkit/craftbukkit/Spigot.java
@@ -7,6 +7,7 @@ import org.bukkit.configuration.file.YamlConfiguration;
 import java.util.List;
 
 public class Spigot {
+    public static boolean tabPing = false;
 
     public static void initialize(CraftServer server, SimpleCommandMap commandMap, YamlConfiguration configuration) {
         commandMap.register("bukkit", new org.bukkit.craftbukkit.command.TicksPerSecondCommand("tps"));
@@ -31,6 +32,7 @@ public class Spigot {
             server.getLogger().severe("[Spigot] You should not disable chunk-gc, unexpected behaviour may occur!");
         }
 
+        tabPing = configuration.getBoolean("settings.tab-ping", tabPing);
     }
 
     /**
diff --git a/src/main/resources/configurations/bukkit.yml b/src/main/resources/configurations/bukkit.yml
index eea3265..a35f3dd 100644
--- a/src/main/resources/configurations/bukkit.yml
+++ b/src/main/resources/configurations/bukkit.yml
@@ -32,6 +32,7 @@ settings:
     spam-exclusions:
        - /skill
     map-send-interval: 10000
+    tab-ping: false
 world-settings:
     default:
         growth-chunks-per-tick: 650
-- 
1.8.1-rc2

