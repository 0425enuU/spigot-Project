From 52d22a6258d9e5ccab14e70b6fb8470fb1a5a7a9 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 24 Feb 2013 20:45:20 +1100
Subject: [PATCH] Enable Improved ping sending

---
 src/main/java/net/minecraft/server/EntityPlayer.java |  1 +
 src/main/java/net/minecraft/server/PlayerList.java   | 16 ++++++++++++++++
 src/main/resources/configurations/bukkit.yml         |  1 +
 3 files changed, 18 insertions(+)

diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index b3c7790..2a77c2f 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -50,6 +50,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     public int newLevel = 0;
     public int newTotalExp = 0;
     public boolean keepLevel = false;
+    public int lastPing = -1; // Spigot
     // CraftBukkit end
 
     public EntityPlayer(MinecraftServer minecraftserver, World world, String s, PlayerInteractManager playerinteractmanager) {
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index 224c57f..ddb2f07 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -713,7 +713,23 @@ public abstract class PlayerList {
             this.sendAll(new Packet201PlayerInfo(entityplayer.name, true, entityplayer.ping));
         }
         // CraftBukkit end */
+        // Spigot start
+        if (this.players.size() == 0 || !org.bukkit.craftbukkit.Spigot.tabPing) {
+            return;
+        }
+        int index = MinecraftServer.currentTick % this.players.size();
+        EntityPlayer player = (EntityPlayer) this.players.get(index);
+        if (player.lastPing == -1 || Math.abs(player.ping - player.lastPing) > 20) {
+            Packet packet = new Packet201PlayerInfo(player.listName, true, player.ping);
+            for (EntityPlayer splayer : (List<EntityPlayer>) this.players) {
+                if (splayer.getBukkitEntity().canSee(player.getBukkitEntity())) {
+                    splayer.playerConnection.sendPacket(packet);
+                }
+            }
+            player.lastPing = player.ping;
+        }
     }
+    // Spigot end
 
     public void sendAll(Packet packet) {
         for (int i = 0; i < this.players.size(); ++i) {
diff --git a/src/main/resources/configurations/bukkit.yml b/src/main/resources/configurations/bukkit.yml
index 7c18391..aac1406 100644
--- a/src/main/resources/configurations/bukkit.yml
+++ b/src/main/resources/configurations/bukkit.yml
@@ -31,6 +31,7 @@ settings:
     command-complete: true
     spam-exclusions:
        - /skill
+    tab-ping: false
     timeout-time: 30
     restart-on-crash: false
     restart-script-location: /path/to/server/start.sh
-- 
1.8.1-rc2

